---description: "Task list for Phase 1 shuttle map implementation"---# Tasks: Real-time Campus Shuttle Map (Phase 1)**Input**: Design documents from `/specs/001-realtime-shuttle-map/`**Prerequisites**: plan.md (required), spec.md (required for user stories), research.md, data-model.md, contracts/**Tests**: Automated tests are REQUIRED for ETA computation, status transitions,and frontend stale/hidden state rendering. Tests MUST be written first and failbefore implementation. If an external interface is introduced or changed,contract tests are REQUIRED. If a change cannot include automated tests,document a manual verification task with risk.**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.## Format: `[ID] [P?] [Story] Description`- **[P]**: Can run in parallel (different files, no dependencies)- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)- Include exact file paths in descriptions## Path Conventions- **Web app**: `backend/src/`, `frontend/src/`- Tests live in `backend/tests/` and `frontend/tests/`## Phase 1: Setup (Shared Infrastructure)**Purpose**: Project initialization and basic structure- [x] T001 Create backend and frontend scaffolds with README stubs in `backend/README.md` and `frontend/README.md`- [x] T002 Initialize backend Node + TypeScript config in `backend/package.json` and `backend/tsconfig.json`- [x] T003 Initialize frontend Vite React + TypeScript config in `frontend/package.json` and `frontend/tsconfig.json`- [x] T004 [P] Configure linting/formatting for backend in `backend/.eslintrc.cjs` and `backend/.prettierrc`- [x] T005 [P] Configure linting/formatting for frontend in `frontend/.eslintrc.cjs` and `frontend/.prettierrc`- [x] T006 [P] Add backend test runner scripts/config in `backend/package.json` and `backend/vitest.config.ts`- [x] T007 [P] Add frontend test runner scripts/config in `frontend/package.json`, `frontend/vitest.config.ts`, and `frontend/playwright.config.ts`---## Phase 2: Foundational (Blocking Prerequisites)**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented**CRITICAL**: No user story work can begin until this phase is complete- [x] T008 Setup backend environment config in `backend/.env.example` and `backend/src/config/env.ts`- [x] T009 [P] Setup frontend environment config in `frontend/.env.example` and `frontend/src/lib/config.ts`- [x] T010 [P] Define status thresholds in `backend/src/services/thresholds.ts` and `frontend/src/lib/thresholds.ts`- [x] T011 Create API server bootstrap in `backend/src/server.ts` and route registry in `backend/src/api/index.ts`- [x] T012 [P] Implement logging with PII redaction in `backend/src/config/logger.ts` and wire into `backend/src/server.ts`- [x] T013 [P] Create shuttle data schemas/validators in `backend/src/validators/shuttle.ts`- [x] T014 Setup frontend app shell and providers in `frontend/src/app/App.tsx` and `frontend/src/app/providers.tsx`- [x] T015 [P] Add Thai-first i18n base and default locale in `frontend/src/i18n/index.ts` and `frontend/src/i18n/th.json`- [x] T016 [P] Create shuttle API client and query hooks shell in `frontend/src/features/shuttle/api.ts` and `frontend/src/features/shuttle/hooks.ts`**Checkpoint**: Foundation ready - user story implementation can now begin in parallel---## Phase 3: User Story 1 - View live shuttle map (Priority: P1) MVP**Goal**: Show the single route, stops, and live vehicle positions on the map with 3-second updates.**Independent Test**: Load the map and confirm route/stops/vehicles render, update, and respond to interactions.### Tests for User Story 1 (required)> **NOTE: Write these tests FIRST, ensure they FAIL before implementation**- [x] T017 [P] [US1] Contract test for route endpoint in `backend/tests/contract/route.contract.spec.ts`- [x] T018 [P] [US1] Contract test for stops endpoint in `backend/tests/contract/stops.contract.spec.ts`- [x] T019 [P] [US1] Contract test for vehicles endpoint in `backend/tests/contract/vehicles.contract.spec.ts`- [x] T020 [P] [US1] UI integration test for map load and interactions in `frontend/tests/integration/map-view.spec.ts`### Implementation for User Story 1- [x] T021 [US1] Implement route endpoint (include server_time, cache headers) in `backend/src/api/route.ts` and register in `backend/src/api/index.ts`- [x] T022 [US1] Implement stops endpoint (include server_time, cache headers) in `backend/src/api/stops.ts` and register in `backend/src/api/index.ts`- [x] T023 [US1] Implement vehicles endpoint (include server_time) and feed adapter in `backend/src/api/vehicles.ts` and `backend/src/services/vehicle-service.ts`- [x] T024 [US1] Build MapLibre map container in `frontend/src/features/map/MapView.tsx`- [x] T025 [US1] Add route and stops sources/layers in `frontend/src/features/map/sources.ts` and `frontend/src/features/map/layers.ts`- [x] T026 [US1] Add vehicles GeoJSON source update via `setData` in `frontend/src/features/map/vehicles-source.ts`- [x] T027 [US1] Add vehicle/stop popups in `frontend/src/components/VehiclePopup.tsx` and `frontend/src/components/StopPopup.tsx`- [x] T028 [US1] Wire map page and data hooks in `frontend/src/pages/MapPage.tsx`**Checkpoint**: User Story 1 is fully functional and testable independently---## Phase 4: User Story 2 - Check stop ETAs with reliability (Priority: P2)**Goal**: Display upcoming ETAs per stop with reliability status and safe fallbacks.**Independent Test**: Select a stop and verify ETA list shows last-updated and fallback states.### Tests for User Story 2 (required)- [x] T029 [P] [US2] Contract test for stop ETAs endpoint in `backend/tests/contract/etas.contract.spec.ts`- [x] T030 [P] [US2] API integration test for ETAs response shaping in `backend/tests/integration/etas.integration.spec.ts`- [x] T031 [P] [US2] UI integration test for stop ETA view in `frontend/tests/integration/stop-eta.spec.ts`### Implementation for User Story 2- [x] T032 [US2] Implement stop ETAs endpoint (include server_time) in `backend/src/api/etas.ts` and service in `backend/src/services/eta-service.ts`- [x] T033 [US2] Add stop ETA query in `frontend/src/features/shuttle/hooks.ts`- [x] T034 [US2] Implement ETA list UI in `frontend/src/components/EtaList.tsx`- [x] T035 [US2] Integrate ETA list into stop popup in `frontend/src/components/StopPopup.tsx`**Checkpoint**: User Stories 1 AND 2 are independently functional---## Phase 5: User Story 3 - Understand data reliability (Priority: P3)**Goal**: Clearly signal fresh/delayed/offline/hidden states and hide stale vehicles.**Independent Test**: Simulate stale timestamps and confirm status transitions and hiding.### Tests for User Story 3 (required)- [x] T036 [P] [US3] Unit test for status thresholds in `backend/tests/unit/status-thresholds.spec.ts`- [x] T037 [P] [US3] Unit test for status badge rendering in `frontend/tests/unit/status-badge.spec.ts`- [x] T038 [P] [US3] UI integration test for hidden vehicle behavior in `frontend/tests/integration/hidden-vehicle.spec.ts`### Implementation for User Story 3- [x] T039 [US3] Implement status derivation helper in `backend/src/services/status.ts`- [x] T040 [US3] Filter hidden vehicles in `backend/src/services/vehicle-service.ts`- [x] T041 [US3] Define status copy constants in `frontend/src/lib/status-copy.ts` and apply in `frontend/src/components/StatusBadge.tsx` and `frontend/src/components/LastUpdated.tsx`- [x] T042 [US3] Add stale/offline banner in `frontend/src/components/StatusBanner.tsx` and wire into `frontend/src/pages/MapPage.tsx`- [x] T043 [US3] Apply status-based styling to vehicle layer in `frontend/src/features/map/layers.ts`**Checkpoint**: All user stories are independently functional---## Phase N: Polish & Cross-Cutting Concerns**Purpose**: Improvements that affect multiple user stories- [x] T044 [P] Accessibility review (contrast, keyboard, labels) in `frontend/src/components/` and `frontend/src/pages/MapPage.tsx`- [x] T045 [P] Thai localization pass and English parity in `frontend/src/i18n/th.json` and `frontend/src/i18n/en.json`- [x] T046 [P] Security/logging review (no PII, HTTPS only) in `backend/src/config/logger.ts`- [x] T047 Performance review to minimize rerenders in `frontend/src/features/map/MapView.tsx`- [x] T048 Run quickstart validation and update `specs/001-realtime-shuttle-map/quickstart.md`- [x] T049 [P] Add any missing unit tests in `frontend/tests/unit/` and `backend/tests/unit/`---## Dependencies & Execution Order### Phase Dependencies- **Setup (Phase 1)**: No dependencies - can start immediately- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories- **User Stories (Phase 3+)**: All depend on Foundational phase completion  - User stories can then proceed in parallel (if staffed)  - Or sequentially in priority order (P1 -> P2 -> P3)- **Polish (Final Phase)**: Depends on all desired user stories being complete### User Story Dependencies- **User Story 1 (P1)**: Can start after Foundational (Phase 2) - No dependencies on other stories- **User Story 2 (P2)**: Can start after Foundational (Phase 2) - May integrate with US1 but should be independently testable- **User Story 3 (P3)**: Can start after Foundational (Phase 2) - May integrate with US1/US2 but should be independently testable### Within Each User Story- Tests MUST be written and FAIL before implementation- Models/schemas before services- Services before endpoints- Core implementation before integration- Story complete before moving to next priority### Parallel Opportunities- All Setup tasks marked [P] can run in parallel- All Foundational tasks marked [P] can run in parallel (within Phase 2)- Once Foundational phase completes, all user stories can start in parallel (if team capacity allows)- All tests for a user story marked [P] can run in parallel- Different user stories can be worked on in parallel by different team members---## Parallel Example: User Story 1```bash# Launch all tests for User Story 1 together:Task: "Contract test for route endpoint in backend/tests/contract/route.contract.spec.ts"Task: "Contract test for stops endpoint in backend/tests/contract/stops.contract.spec.ts"Task: "Contract test for vehicles endpoint in backend/tests/contract/vehicles.contract.spec.ts"Task: "UI integration test for map load and interactions in frontend/tests/integration/map-view.spec.ts"# Launch independent implementation tasks together:Task: "Add route and stops sources/layers in frontend/src/features/map/sources.ts"Task: "Implement route endpoint in backend/src/api/route.ts"Task: "Implement stops endpoint in backend/src/api/stops.ts"```---## Implementation Strategy### MVP First (User Story 1 Only)1. Complete Phase 1: Setup2. Complete Phase 2: Foundational (CRITICAL - blocks all stories)3. Complete Phase 3: User Story 14. **STOP and VALIDATE**: Test User Story 1 independently5. Deploy/demo if ready### Incremental Delivery1. Complete Setup + Foundational -> Foundation ready2. Add User Story 1 -> Test independently -> Deploy/Demo (MVP!)3. Add User Story 2 -> Test independently -> Deploy/Demo4. Add User Story 3 -> Test independently -> Deploy/Demo5. Each story adds value without breaking previous stories### Parallel Team StrategyWith multiple developers:1. Team completes Setup + Foundational together2. Once Foundational is done:   - Developer A: User Story 1   - Developer B: User Story 2   - Developer C: User Story 33. Stories complete and integrate independently---## Notes- [P] tasks = different files, no dependencies- [Story] label maps task to specific user story for traceability- Each user story should be independently completable and testable- Verify tests fail before implementing- Commit after each task or logical group- Stop at any checkpoint to validate story independently- Avoid: vague tasks, same file conflicts, cross-story dependencies that break independence